
<!DOCTYPE html>
<html>
<head>
<script th:src="@{/ckeditor/ckeditor.js}" type="text/javascript"></script>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Tin tức</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" type="image/x-icon"
	th:href="@{/assets/img/favicon.ico}" />

<!-- CSS here -->
<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/slicknav.css}" />
<link rel="stylesheet" th:href="@{/assets/css/animate.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/magnific-popup.css}" />
<link rel="stylesheet" th:href="@{/assets/css/fontawesome-all.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}" />
<link rel="stylesheet" th:href="@{/assets/css/slick.css}" />
<link rel="stylesheet" th:href="@{/assets/css/nice-select.css}" />
<link rel="stylesheet" th:href="@{/assets/css/style.css}" />
<link rel="stylesheet" th:href="@{/assets/css/login.css}" />
</head>
<body>
	<!-- <div th:replace="/user/header.html :: head"></div>
	<div>
		<div th:each="s : ${productDTOs}"  style="border:1px solid red;">
			<p th:text="${s.id}"></p>
			<p th:text="${s.productName}"></p>
			<p th:text="${s.productDescription}"></p>
			<img style="width: 200px;" th:src="${s.image}">
			<div th:each="r:${s.productResourceDTOs}">
				<p th:text="${r.resource.resourceName}"></p>
				<p th:text="${r.gram}"></p> gram
				
			</div>
		</div>
	</div> -->

<div th:replace="/user/header.html :: head"></div>

	<main>
	<div class="modal fade" id="notifyModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">...</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">...</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
				</div>
			</div>
		</div>
	</div>
		<!--================Blog Area =================-->
		<section class="blog_area section-padding">
			<div class="container">
				<div class="row">
					<div class="col-lg-8 mb-5 mb-lg-0">
					<div id="wrapper">
		
		<!-- /. NAV SIDE  -->
		<div id="page-wrapper">
			<div id="page-inner">
				<div class="row">
					<div class="col-md-12">
						<h2>Sửa món ăn</h2>

					</div>
				</div>
				<!-- /. ROW  -->
				<hr />
				<div class="row">
					<div class="col-md-12">
						<!-- Form Elements -->
						<div class="panel panel-default">
							<div class="panel-heading">sửa món ăn</div>
							<div class="panel-body">
								<div class="row">
									<div class="col-md-6">
										<h3>Thông tin món ăn</h3>
										<form role="form" th:action="@{/admin/product/edit-product}"
											method="post" enctype="multipart/form-data"
											th:object="${productDTO}" th:modelattribute="${productDTO}"
											id="editProduct">
											<div class="form-group">
												  <input class="form-control"
													placeholder="Tên món ăn"  type="hidden" id="id"
													th:value="${productDTO.id}" />
											</div>
											<div class="form-group">
												<label>Tên món ăn:</label> <input class="form-control"
													placeholder="Tên món ăn" name="productName"  id="productName"
													th:value="${productDTO.productName}" />
											</div>
											<div class="form-group">
												<label>Mô tả món ăn:</label>
												<textarea class="ckeditor" rows="4" cols="50"
													name="detailDescription"
													th:field="*{productDescription}" id="productDescription"></textarea>
											</div>
											<div class="form-group">
												<label for="image">Ảnh</label> <input 
													th:field="*{image}" disabled>
											</div>
											<div class="form-group">
												<label for="image">Chọn hình ảnh</label> <input type="file"
													name="image" id="image" accept="image/*">
											</div>
											<div class="form-group">
												<label>Loại nguyên liệu</label> <br> <select
													class="category" name="category" id="category">
													<option value="0">--</option>
													<option th:each="cat: ${categoryList}" th:value="${cat.id}"
														th:text="${cat.categoryName}"></option>
												</select>
											</div>
											<div class="form-group">
												<label>Nguyên liệu</label>
												<ul id="checkbox"
													style="list-style: none; overflow-y: scroll; height: 250px;">Vui
													lòng chọn loại nguyên liệu
												</ul>
												<input class="form-control" placeholder="Nguyên liệu"
													th:value="${productDTO.resources}" disabled="disabled" />
											</div>
											<!-- table of resources -->
											<div class="form-group">
												<label>Bảng nguyên liệu</label>
												<div class="panel-body">
													<div class="table-responsive">

														<table
															class="table table-striped table-bordered table-hover">
															<thead>
																<tr>
																	<th>STT</th>
																	<th>Tên nguyên liệu</th>
																	<th>Kcal/1g</th>
																	<th>Khối lượng (gram)</th>
																	<th>Lượng calo</th>

																</tr>
															</thead>
															<tbody id="resource-table">
																<tr>
																	<td></td>
																	<td></td>
																	<td></td>
																	<td><input style="width: 100%;" type="number"></td>
																	<td></td>
																</tr>
																<tr>
																	<td class="text-center" colspan="4">Tổng số calo</td>
																	<td></td>
																</tr>
															</tbody>

														</table>
													</div>

												</div>
											</div>
											<!-- end table of resources -->
											<button type="submit" class="btn btn-primary">Sửa
												món ăn</button>
											<button type="reset" class="btn btn-default">Làm mới</button>
										</form>


									</div>
								</div>
							</div>
						</div>
						<!-- End Form Elements -->
					</div>
				</div>
				<!-- /. ROW  -->
				<div class="row">
					<div class="col-md-12"></div>
				</div>
				<!-- /. ROW  -->
			</div>
			<!-- /. PAGE INNER  -->
		</div>
		<!-- /. PAGE WRAPPER  -->
	</div>		
	
					</div>
					<!-- right side -->
					<div th:replace="/user/rightProduct.html :: rightProduct"></div>
					<!-- end right side -->
				</div>
			</div>
		</section>
		<!--================Blog Area =================-->
	</main>
	<div th:replace="/user/footer :: foot"></div>

	<script th:src="@{/assets/js/vendor/modernizr-3.5.0.min.js}"></script>
	<!-- Jquery, Popper, Bootstrap -->
	<script th:src="@{/assets/js/vendor/jquery-1.12.4.min.js}"></script>
	<script th:src="@{/assets/js/popper.min.js}"></script>
	<script th:src="@{/assets/js/bootstrap.min.js}"></script>
	<!-- Jquery Mobile Menu -->
	<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>

	<!-- Jquery Slick , Owl-Carousel Plugins -->
	<script th:src="@{/assets/js/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/js/slick.min.js}"></script>

	<!-- One Page, Animated-HeadLin -->
	<script th:src="@{/assets/js/wow.min.js}"></script>
	<script th:src="@{/assets/js/animated.headline.js}"></script>
	<script th:src="@{/assets/js/jquery.magnific-popup.js}"></script>

	<!-- Nice-select, sticky -->
	<script th:src="@{/assets/js/jquery.nice-select.min.js}"></script>
	<script th:src="@{/assets/js/jquery.sticky.js}"></script>

	<!-- contact js -->
	<script th:src="@{/assets/js/contact.js}"></script>
	<script th:src="@{/assets/js/jquery.form.js}"></script>
	<script th:src="@{/assets/js/jquery.validate.min.js}"></script>
	<script th:src="@{/assets/js/mail-script.js}"></script>
	<script th:src="@{/assets/js/jquery.ajaxchimp.min.js}"></script>

	<!-- Jquery Plugins, main Jquery -->
	<script th:src="@{/assets/js/plugins.js}"></script>
	<script th:src="@{/assets/js/main.js}"></script>
	<script>
	var currentDisplayResource = [];
	var resourceList = [];

	function setEventInputGram() {
	    $('.input-gram').change(function () {
	        var value = $(this).val();
	        var id = $(this).attr('resource-id-input');
	        for (var r of resourceList) {
	            if (r.id == id) {
	                if (value == "" || value === undefined) {
	                    r.gram = 0;
	                    $(this).val(0);
	                } else {
	                    r.gram = value;
	                }
	                $("td[resource-id-total='" + id + "']").html((r.kcal1g * r.gram).toFixed(2));
	            }
	        }
	        var totalKcal = 0;
	        for (var r of resourceList) {
	            totalKcal += r.kcal1g * r.gram
	        }
	        $("#total-kcal").html(totalKcal.toFixed(2));
	    });
	    console.log(resourceList);
	}

	function drawBottomTable() {
	    var totalKcal = 0;
	    html = "";
	    for (var i = 0; i < resourceList.length; i++) {
	        totalKcal += resourceList[i].kcal1g * resourceList[i].gram
	        html += '<tr>';
	        html += '<td>' + (i + 1) + '</td>';
	        html += '<td>' + resourceList[i].resourceName + '</td>';
	        html += '<td>' + resourceList[i].kcal1g + '</td>';
	        html += '<td><input class="input-gram" resource-id-input="' + resourceList[i].id + '" style="width: 100%;" type="number" value="' + resourceList[i].gram + '"></td>'
	        html += '<td resource-id-total="' + resourceList[i].id + '">' + (resourceList[i].kcal1g * resourceList[i].gram).toFixed(2) + '</td>';
	        html += '</tr>';
	    }
	    html += '<tr>';
	    html += '<td class="text-center" colspan="4">Tổng số calo</td>';
	    html += '<td id="total-kcal">' + totalKcal.toFixed(2) + '</td>';
	    html += '</tr>';
	    $("#resource-table").html(html);
	    this.setEventInputGram();
	}

	function setEventCheckbox() {
	    $(".resource-checkbox").click(function () {
	        if ($(this).is(':checked')) {
	            for (var e of currentDisplayResource) {
	                if (e.id == $(this).val()) {
	                    resourceList.push(e);
	                    break;
	                }
	            }
	        } else {
	            for (var i = 0; i < resourceList.length; i++) {
	                if (resourceList[i].id == $(this).val()) {
	                    resourceList.splice(i, 1);
	                    break;
	                }
	            }
	        }
	        // console.log('resourceList: ', resourceList);
	        drawBottomTable();
	    });
	}

	$(document).ready(function () {
	    $('#dataTables-example').dataTable();
	});
	$("#category").change(function () {
	    var categoryId = $("#category").val();
	    if (categoryId == 0) {
	        return;
	    }
	    $.ajax({
	        url: document.location.origin + "/user/resource/resourceCat/" + categoryId,
	        type: 'GET',
	        dataType: 'json',
	    }).done(function (result) {
	        var html = "";
	        currentDisplayResource = [];
	        for (var r of result) {
	            html += '<div class="checkbox">';
	            html += '<li><label><input class="resource-checkbox" type="checkbox" value="' + r.id + '" name="resource">' + r.resourceName + ' (' + r.kcal1g + ' kcal/g)' + '</label></li>';
	            html += '</div>';
	            r.gram = 0;
	            currentDisplayResource.push(r);
	        }
	        $("#checkbox").html(html);
	        setEventCheckbox();
	    });
	});

	function notify(title, message) {
		console.log(title)
	    $("#notifyModal .modal-title").html(title);
	    $("#notifyModal .modal-body").html(message);
	    $("#notifyModal").modal({ backdrop: "static" });
	}

	$("#editProduct").submit(function (e) {
	    e.preventDefault();
	    var productName = $("#productName").val();
	    var productDescription = CKEDITOR.instances.productDescription.getData();
	    var image = $('#image')[0].files[0];
	    var id =$("#id").val();
	   
	    var form_data = new FormData();
	    form_data.append('productName', productName);
	    form_data.append('productDescription', productDescription);
	    form_data.append('image', image);
	    form_data.append('id', id)
	   console.log("123")
	    $.ajax({
	        url: document.location.origin + "/user/product/edit-product",
	        type: 'POST',
	        cache: false,
	        processData: false,
	        contentType: false,
	        data: form_data,
	        error: function () {
	            notify("Lỗi", "Không thể xử lí dữ liệu");
	        }
	    }).done(function (result) {
	    	console.log("12388080")
	        var ProductResource2Dto = {
	            resources: resourceList,
	            productId:id
	        }
	        $.ajax({
	            url: document.location.origin + "/user/product/edit-resources-to-product",
	            type: 'POST',
		        dataType: "text",
	            contentType: 'application/json',
	            data: JSON.stringify(ProductResource2Dto),
	            success: function(data){
	            	
	                notify("Thông báo", "Cập nhập món ăn thành công");
			    },
		        error: function(error){
		        	console.log(error)
		        	notify("Lỗi", "Không thể xử lí dữ liệu");
		        }
	           
	        });
	    });
	});

	$("#btn-reset").click(function () {
	    resourceList = [];
	    drawBottomTable();
	});
	</script>
</body>
</html>
