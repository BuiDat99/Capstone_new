
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Tin tức</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="shortcut icon" type="image/x-icon"
	th:href="@{/assets/img/favicon.ico}" />

<!-- CSS here -->
<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/slicknav.css}" />
<link rel="stylesheet" th:href="@{/assets/css/animate.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/magnific-popup.css}" />
<link rel="stylesheet" th:href="@{/assets/css/fontawesome-all.min.css}" />
<link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}" />
<link rel="stylesheet" th:href="@{/assets/css/slick.css}" />
<link rel="stylesheet" th:href="@{/assets/css/nice-select.css}" />
<link rel="stylesheet" th:href="@{/assets/css/style.css}" />
<link rel="stylesheet" th:href="@{/assets/css/login.css}" />
	<link th:href="@{/js/dataTables/dataTables.bootstrap.css}" rel="stylesheet" />
	<link th:href="@{/css/add-product.css}" rel="stylesheet" />
	<script th:src="@{/ckeditor/ckeditor.js}" type="text/javascript"></script>
</head>
<body>
	<!-- <div th:replace="/user/header.html :: head"></div>
	<div>
		<div th:each="s : ${productDTOs}"  style="border:1px solid red;">
			<p th:text="${s.id}"></p>
			<p th:text="${s.productName}"></p>
			<p th:text="${s.productDescription}"></p>
			<img style="width: 200px;" th:src="${s.image}">
			<div th:each="r:${s.productResourceDTOs}">
				<p th:text="${r.resource.resourceName}"></p>
				<p th:text="${r.gram}"></p> gram
				
			</div>
		</div>
	</div> -->

<div th:replace="user/header.html :: head"></div>

	<main>
	<div class="modal fade" id="notifyModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">...</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">...</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
				</div>
			</div>
		</div>
	</div>
		<!--================Blog Area =================-->
		<section class="blog_area section-padding">
			<div class="container">
				<div class="row">
					<div class="col-lg-8 mb-5 mb-lg-0">		
		<!-- /. NAV SIDE  -->
		<div id="page-wrapper">
			<div id="page-inner">
				<div class="row">
					<div class="col-md-12">
						<h2>Thêm món ăn mới</h2>

					</div>
				</div>
				<!-- /. ROW  -->
				<hr />
				<div class="row">
					<div class="col-md-12">
						<!-- Form Elements -->
						<div class="panel panel-default">
							<div class="panel-body">
								<div class="row">
									<div class="col-md-6">
										<h3>Thông tin món ăn</h3>
										<form role="form" id="addProductForm">
											<div class="form-group" id="add-product-form">
												<label>Tên món ăn:</label> <input class="form-control"
													placeholder="Tên món ăn" id="productName" required />
											</div>
											<div class="form-group">
												<label>Mô tả món ăn:</label>
												<textarea class="ckeditor" rows="4" cols="50" id="productDescription"
													required></textarea>
											</div>
											<div class="form-group">
												<label for="image">Hình ảnh</label>
												<input type="file" id="image" required accept="image/*">
											</div>
											<div class="form-group">
												<label>Loại nguyên liệu</label> <br> <select class="category"
													name="category" id="category">
													<option value="0">--</option>
													<option th:each="cat: ${categoryList}" th:value="${cat.id}"
														th:text="${cat.categoryName}"></option>
												</select>
											</div>
											<div class="form-group">
												<label>Nguyên liệu</label>
												<ul id="checkbox"
													style="list-style: none; overflow-y: scroll; height: 250px;">Vui
													lòng chọn loại nguyên liệu
												</ul>
											</div>
											<!-- table of resources -->
											<div class="form-group">
												<label>Bảng nguyên liệu</label>
												<div class="panel-body">
													<div class="table-responsive">

														<table class="table table-striped table-bordered table-hover">
															<thead>
																<tr>
																	<th>STT</th>
																	<th>Tên nguyên liệu</th>
																	<th>Kcal/1g</th>
																	<th>Khối lượng (gram)</th>
																	<th>Lượng calo</th>

																</tr>
															</thead>
															<tbody id="resource-table">
																<tr>
																	<td class="text-center" colspan="4">Tổng số calo
																	</td>
																	<td></td>
																</tr>
															</tbody>

														</table>
													</div>

												</div>
											</div>
											<!-- end table of resources -->
											<button type="submit" class="btn btn-primary">Thêm món ăn</button>
											<button type="reset" class="btn btn-default" id="btn-reset">Làm mới</button>
										</form>


									</div>
								</div>
							</div>
						</div>
						<!-- End Form Elements -->
					</div>
				</div>
				<!-- /. ROW  -->
				<div class="row">
					<div class="col-md-12"></div>
				</div>
				<!-- /. ROW  -->
			</div>
			<!-- /. PAGE INNER  -->
		</div>
		<!-- /. PAGE WRAPPER  -->
					</div>
					<!-- right side -->
					<div th:replace="user/rightProduct.html :: rightProduct"></div>
					<!-- end right side -->
				</div>
			</div>
		</section>
		<!--================Blog Area =================-->
	</main>
	<div th:replace="user/footer :: foot"></div>

	<script th:src="@{/js/jquery-1.10.2.js}"></script>
	<!-- BOOTSTRAP SCRIPTS -->
	<script th:src="@{/js/bootstrap.min.js}"></script>
	<!-- METISMENU SCRIPTS -->
	<script th:src="@{/js/jquery.metisMenu.js}"></script>
	<!-- DATA TABLE SCRIPTS -->
	<script th:src="@{/js/dataTables/jquery.dataTables.js}"></script>
	<script th:src="@{/js/dataTables/dataTables.bootstrap.js}"></script>
		<script type="text/javascript">
	var currentDisplayResource = [];
	var resourceList = [];

	function setEventInputGram() {
	    $('.input-gram').change(function () {
	        var value = $(this).val();
	        var id = $(this).attr('resource-id-input');
	        for (var r of resourceList) {
	            if (r.id == id) {
	                if (value == "" || value === undefined) {
	                    r.gram = 0;
	                    $(this).val(0);
	                } else {
	                    r.gram = value;
	                }
	                $("td[resource-id-total='" + id + "']").html((r.kcal1g * r.gram).toFixed(2));
	            }
	        }
	        var totalKcal = 0;
	        for (var r of resourceList) {
	            totalKcal += r.kcal1g * r.gram
	        }
	        $("#total-kcal").html(totalKcal.toFixed(2));
	    });
	    console.log(resourceList);
	}

	function drawBottomTable() {
	    var totalKcal = 0;
	    html = "";
	    for (var i = 0; i < resourceList.length; i++) {
	        totalKcal += resourceList[i].kcal1g * resourceList[i].gram
	        html += '<tr>';
	        html += '<td>' + (i + 1) + '</td>';
	        html += '<td>' + resourceList[i].resourceName + '</td>';
	        html += '<td>' + resourceList[i].kcal1g + '</td>';
	        html += '<td><input class="input-gram" resource-id-input="' + resourceList[i].id + '" style="width: 100%;" type="number" value="' + resourceList[i].gram + '"></td>'
	        html += '<td resource-id-total="' + resourceList[i].id + '">' + (resourceList[i].kcal1g * resourceList[i].gram).toFixed(2) + '</td>';
	        html += '</tr>';
	    }
	    html += '<tr>';
	    html += '<td class="text-center" colspan="4">Tổng số calo</td>';
	    html += '<td id="total-kcal">' + totalKcal.toFixed(2) + '</td>';
	    html += '</tr>';
	    $("#resource-table").html(html);
	    this.setEventInputGram();
	}

	function setEventCheckbox() {
	    $(".resource-checkbox").click(function () {
	        if ($(this).is(':checked')) {
	            for (var e of currentDisplayResource) {
	                if (e.id == $(this).val()) {
	                    resourceList.push(e);
	                    break;
	                }
	            }
	        } else {
	            for (var i = 0; i < resourceList.length; i++) {
	                if (resourceList[i].id == $(this).val()) {
	                    resourceList.splice(i, 1);
	                    break;
	                }
	            }
	        }
	        // console.log('resourceList: ', resourceList);
	        drawBottomTable();
	    });
	}

	$(document).ready(function () {
	    $('#dataTables-example').dataTable();
	});
	$("#category").change(function () {
	    var categoryId = $("#category").val();
	    if (categoryId == 0) {
	        return;
	    }
	    $.ajax({
	        url: document.location.origin + "/user/resource/resourceCat/" + categoryId,
	        type: 'GET',
	        dataType: 'json',
	    }).done(function (result) {
	        var html = "";
	        currentDisplayResource = [];
	        for (var r of result) {
	            html += '<div class="checkbox">';
	            html += '<li><label><input class="resource-checkbox" type="checkbox" value="' + r.id + '" name="resource">' + r.resourceName + ' (' + r.kcal1g + ' kcal/g)' + '</label></li>';
	            html += '</div>';
	            r.gram = 0;
	            currentDisplayResource.push(r);
	        }
	        $("#checkbox").html(html);
	        setEventCheckbox();
	    });
	});

	function notify(title, message) {
	    $("#notifyModal .modal-title").html(title);
	    $("#notifyModal .modal-body").html(message);
	    $("#notifyModal").modal({ backdrop: "static" });
	}

	$("#addProductForm").submit(function (e) {
	    e.preventDefault();
	    var productName = $("#productName").val();
	    var productDescription = CKEDITOR.instances.productDescription.getData();
	    var image = $('#image')[0].files[0];

	    var form_data = new FormData();
	    form_data.append('productName', productName);
	    form_data.append('productDescription', productDescription);
	    form_data.append('image', image);

	    $.ajax({
	        url: document.location.origin + "/user/product/add-product",
	        type: 'POST',
	        cache: false,
	        processData: false,
	        contentType: false,
	        data: form_data,
	        error: function () {
	            notify("Lỗi", "Không thể xử lí dữ liệu");
	        }
	    }).done(function (result) {
	        var productResource = {
	            productId: result,
	            resources: resourceList
	        }

	        $.ajax({
	            url: document.location.origin + "/user/product/add-resources-to-product",
	            type: 'POST',
	            contentType: 'application/json',
	            data: JSON.stringify(productResource),
	            error: function () {
	                notify("Lỗi", "Không thể xử lí dữ liệu");
	            }
	        }).done(function (result) {
	            notify("Thông báo", "Thêm món ăn thành công");
	        });
	        notify("Thông báo", "Thêm món ăn thành công");
	    });
	});

	$("#btn-reset").click(function () {
	    resourceList = [];
	    drawBottomTable();
	});
	</script>
</body>
</html>
